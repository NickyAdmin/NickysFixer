package me.nickyadmin.nickysfixer.exploits;

import me.nickyadmin.nickysfixer.Main;
import me.nickyadmin.nickysfixer.utils.GetTps_1_12_R1;
import org.bukkit.Chunk;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Entity;
import org.bukkit.entity.FallingBlock;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockPhysicsEvent;
import org.bukkit.event.entity.EntityChangeBlockEvent;

public class EntityFix implements Listener {
    private final Main plugin;

    public EntityFix(Main plugin) {
        this.plugin = plugin;
    }
    @EventHandler
    public void onEntityChange(BlockPhysicsEvent event) {
        FileConfiguration config = plugin.getConfig();
        if (config.getBoolean("disable-physics-at-low-tps")) {
            if (GetTps_1_12_R1.getTps() <= config.getDouble("tps-to-disable-physics")) {
                event.setCancelled(true);
            }
        }
    }
    @EventHandler
    public void onFallingChangeTps(EntityChangeBlockEvent event) {
        FileConfiguration config = plugin.getConfig();
        if (config.getBoolean("fix-falling-entities-crash")) {
            Chunk chunk = event.getBlock().getChunk();
            int limit = 0;
            for (Entity entity : chunk.getEntities()) {
                if (entity instanceof FallingBlock) {
                    if (limit < config.getInt("max-per-chunk")) {
                        limit++;
                        continue;
                    } else {
                        entity.remove();
                        break;
                    }
                }
            }
        }
    }
    @EventHandler
    public void onFallingChange(EntityChangeBlockEvent event) {
        FileConfiguration config = plugin.getConfig();
        if (config.getBoolean("fix-falling-entities-crash")) {
            if (GetTps_1_12_R1.getTps() <= config.getDouble("tps-to-disable-sand")) {
                event.setCancelled(true);
            }
        }
    }
    @EventHandler
    public void onEntityChangeTps(BlockPhysicsEvent event) {
        FileConfiguration config = plugin.getConfig();
        if (config.getBoolean("fix-falling-entities-crash")) {
            Chunk chunk = event.getBlock().getChunk();
            int limit = 0;
            for (Entity entity : chunk.getEntities()) {
                if (entity instanceof FallingBlock) {
                    if (limit < config.getInt("max-per-chunk")) {
                        limit++;
                        continue;
                    } else {
                        entity.remove();
                        break;
                    }
                }
            }
        }
    }
}