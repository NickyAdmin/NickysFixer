package me.nickyadmin.nickysfixer.exploits;

import me.nickyadmin.nickysfixer.Main;
import me.nickyadmin.nickysfixer.utils.GetTps;
import org.bukkit.ChatColor;
import org.bukkit.Material;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerDropItemEvent;
import org.bukkit.inventory.ItemStack;

import java.util.HashMap;
import java.util.Map;

public class BookDropCrash implements Listener {
    Map<String, Long> dropcool = new HashMap<>();
    private final Main plugin;

    public BookDropCrash(Main plugin) {
        this.plugin = plugin;
    }

    @EventHandler
    public void onDrop(PlayerDropItemEvent event) {
        Player p = event.getPlayer();
        FileConfiguration config = plugin.getConfig();
        ItemStack item = event.getItemDrop().getItemStack();
        if (config.getBoolean("fix-book-data-drop-crash") && (item.getType() == Material.WRITTEN_BOOK
                || item.getType() == Material.BLACK_SHULKER_BOX
                || item.getType() == Material.BLUE_SHULKER_BOX
                || item.getType() == Material.GREEN_SHULKER_BOX
                || item.getType() == Material.CYAN_SHULKER_BOX
                || item.getType() == Material.GRAY_SHULKER_BOX
                || item.getType() == Material.LIGHT_BLUE_SHULKER_BOX
                || item.getType() == Material.LIME_SHULKER_BOX
                || item.getType() == Material.MAGENTA_SHULKER_BOX
                || item.getType() == Material.ORANGE_SHULKER_BOX
                || item.getType() == Material.PINK_SHULKER_BOX
                || item.getType() == Material.PURPLE_SHULKER_BOX
                || item.getType() == Material.RED_SHULKER_BOX
                || item.getType() == Material.SILVER_SHULKER_BOX
                || item.getType() == Material.WHITE_SHULKER_BOX
                || item.getType() == Material.YELLOW_SHULKER_BOX)) {
            if (GetTps.getTps() <= config.getDouble("tps-to-enable-the-cooldown")) {
                if (dropcool.containsKey((p.getName()))) {
                    if (dropcool.get(p.getName()) > System.currentTimeMillis()) {
                        if (config.getBoolean("fix-book-data-drop-crash-message")) {
                            p.sendMessage(ChatColor.DARK_RED + "[NickysFixer] " + ChatColor.DARK_AQUA + "please wait a bit before dropping this item");
                        }
                        event.setCancelled(true);
                    }
                }
                dropcool.put(p.getName(), System.currentTimeMillis() + (config.getInt("drop-cooldown-for-blacklisted-items")));
            }
        }
    }
}

